<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>MIDI –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—å</title>

	<!-- –°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä -->
	<script src="WebAudioFontPlayer.js"></script>

	<!-- –ó–≤—É–∫–æ–≤–æ–π —à—Ä–∏—Ñ—Ç -->
	<script src="0400_Aspirin_sf2_file.js"></script>

	<!-- –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π MIDI-–¥–µ–∫–æ–¥–µ—Ä -->
	<script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.min.js"></script>

	<style>
		body {
			font-family: sans-serif;
			padding: 20px;
			background: #f0f0f0;
		}

		h1 {
			margin-bottom: 10px;
		}

		input,
		button {
			margin-top: 10px;
			margin-right: 10px;
		}
	</style>
</head>

<body>
	<h1>MIDI –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ</h1>

	<input type="file" accept=".mid,.midi" onchange="loadMIDI(this.files[0])">
	<br>
	<button onclick="playMIDI()">‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</button>
	<button onclick="stopMIDI()">‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>

	<script>
		const player = new WebAudioFontPlayer();
		const audioContext = new (window.AudioContext || window.webkitAudioContext)();
		const selectedPreset = _tone_0400_Aspirin_sf2_file;
		let scheduledEvents = [];
		let presetLoaded = true; // —Å—Ä–∞–∑—É true, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø—Ä–µ—Å–µ—Ç —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ <script>
		let midiData = null;



		// –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–∞—Ä—Å–∏–Ω–≥ MIDI-—Ñ–∞–π–ª–∞
		function loadMIDI(file) {
			const reader = new FileReader();
			reader.onload = function (e) {
				const midi = new Midi(e.target.result);
				midiData = midi;
				console.log("üìÑ MIDI —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω. –ì–æ—Ç–æ–≤ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é.");
			};
			reader.readAsArrayBuffer(file);
		}

		// –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
		function playMIDI() {
			if (!presetLoaded || !midiData) {
				alert("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ MIDI-—Ñ–∞–π–ª –∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ—Å–µ—Ç–∞.");
				return;
			}

			stopMIDI(); // –û—á–∏—Å—Ç–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º
			const currentTime = audioContext.currentTime;

			midiData.tracks.forEach(track => {
				track.notes.forEach(note => {
					const when = currentTime + note.time;
					const duration = note.duration;
					const pitch = note.midi;
					const velocity = note.velocity;

					player.queueWaveTable(
						audioContext,
						audioContext.destination,
						selectedPreset,
						when,
						pitch,
						duration,
						velocity
					);

					scheduledEvents.push({ when, pitch });
				});
			});

			console.log("‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ.");
		}

		// –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
		function stopMIDI() {
			player.cancelQueue(audioContext);
			scheduledEvents = [];
			console.log("‚èπ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.");
		}
	</script>
</body>

</html>